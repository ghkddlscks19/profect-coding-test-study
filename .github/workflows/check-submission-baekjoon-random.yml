# .github/workflows/check-submission-baekjoon-random.yml
name: Check Daily Random Baekjoon Submissions

on:
  schedule:
    # Îß§Ïùº Ïò§ÌõÑ 11Ïãú 30Î∂Ñ (UTC Í∏∞Ï§Ä 14:30 = ÌïúÍµ≠ÏãúÍ∞Ñ 23:30)
    - cron: '30 14 * * *'
  workflow_dispatch: # ÏàòÎèô Ïã§ÌñâÎèÑ Í∞ÄÎä•

jobs:
  check-submissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Calculate today's day number
      id: calculate
      run: |
        START_DATE="2025-12-11"
        TODAY=$(date +%Y-%m-%d)
        
        DAYS_DIFF=$(( ( $(date -d "$TODAY" +%s) - $(date -d "$START_DATE" +%s) ) / 86400 ))
        # ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïä§Í∞Ä Day 1-79ÏòÄÏúºÎØÄÎ°ú Î∞±Ï§ÄÏùÄ Day 80Î∂ÄÌÑ∞ ÏãúÏûë
        DAY_NUMBER=$(( $DAYS_DIFF + 80 ))
        
        echo "day_number=$DAY_NUMBER" >> $GITHUB_OUTPUT
        echo "current_date=$TODAY" >> $GITHUB_OUTPUT
        
        if [ $DAY_NUMBER -lt 80 ]; then
          echo "out_of_range=true" >> $GITHUB_OUTPUT
        else
          echo "out_of_range=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Find today's problem folder
      if: steps.calculate.outputs.out_of_range == 'false'
      id: find_folder
      run: |
        DAY_NUMBER=${{ steps.calculate.outputs.day_number }}
        DAY_PREFIX="day$(printf "%04d" $DAY_NUMBER)"
        
        # problems/ ÎîîÎ†âÌÜ†Î¶¨ÏóêÏÑú Ïò§Îäò ÎÇ†ÏßúÎ°ú ÏãúÏûëÌïòÎäî Ìè¥Îçî Ï∞æÍ∏∞
        FOLDER_PATH=$(find problems -maxdepth 1 -type d -name "${DAY_PREFIX}-*" | head -n 1)
        
        if [ -z "$FOLDER_PATH" ]; then
          echo "‚ùå Ïò§ÎäòÏùò Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
          echo "folder_found=false" >> $GITHUB_OUTPUT
        else
          echo "üìÇ Ïò§ÎäòÏùò Ìè¥Îçî: $FOLDER_PATH"
          echo "folder_found=true" >> $GITHUB_OUTPUT
          echo "folder_path=$FOLDER_PATH" >> $GITHUB_OUTPUT
          
          # Ìè¥ÎçîÎ™ÖÏóêÏÑú Î¨∏Ï†ú Î≤àÌò∏ÏôÄ Ïù¥Î¶Ñ Ï∂îÏ∂ú
          # ÌòïÏãù: day0001-1000-AB
          FOLDER_NAME=$(basename "$FOLDER_PATH")
          PROBLEM_NUMBER=$(echo "$FOLDER_NAME" | cut -d'-' -f2)
          PROBLEM_NAME=$(echo "$FOLDER_NAME" | cut -d'-' -f3-)
          
          echo "problem_number=$PROBLEM_NUMBER" >> $GITHUB_OUTPUT
          echo "problem_name=$PROBLEM_NAME" >> $GITHUB_OUTPUT
        fi
        
    - name: Check submissions
      if: steps.calculate.outputs.out_of_range == 'false' && steps.find_folder.outputs.folder_found == 'true'
      id: check
      run: |
        FOLDER_PATH="${{ steps.find_folder.outputs.folder_path }}"
        
        declare -a members=("Ìô©Ïù∏Ï∞¨" "Ïú†ÎèÑÌòÑ" "Î∞∞ÏùÄÍ≤Ω" "ÎÇ®Ïó∞Ïö∞" "Ïú§Ìò∏ÏÉÅ" "ÍπÄÌòÑÍ≤Ω")
        
        SUBMITTED=()
        MISSING=()
        
        for member in "${members[@]}"; do
          found=false
          for ext in "java" "py" "cpp" "js" "kt" "go" "swift" "c" "cs"; do
            if [ -f "$FOLDER_PATH/${member}.${ext}" ]; then
              SUBMITTED+=("$member")
              found=true
              break
            fi
          done
          
          if [ "$found" = false ]; then
            MISSING+=("$member")
          fi
        done
        
        SUBMITTED_COUNT=${#SUBMITTED[@]}
        MISSING_COUNT=${#MISSING[@]}
        TOTAL_MEMBERS=${#members[@]}
        
        echo "submitted_count=$SUBMITTED_COUNT" >> $GITHUB_OUTPUT
        echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
        echo "total_members=$TOTAL_MEMBERS" >> $GITHUB_OUTPUT
        
        IFS=',' 
        SUBMITTED_LIST="${SUBMITTED[*]}"
        MISSING_LIST="${MISSING[*]}"
        IFS=' '
        
        echo "submitted_list=$SUBMITTED_LIST" >> $GITHUB_OUTPUT
        echo "missing_list=$MISSING_LIST" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Ï†úÏ∂ú ÏôÑÎ£å ($SUBMITTED_COUNT/$TOTAL_MEMBERS): $SUBMITTED_LIST"
        echo "‚ùå ÎØ∏Ï†úÏ∂ú ($MISSING_COUNT/$TOTAL_MEMBERS): $MISSING_LIST"
        
    - name: Send submission status to Discord
      if: steps.calculate.outputs.out_of_range == 'false' && steps.find_folder.outputs.folder_found == 'true'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        DAY_NUMBER=${{ steps.calculate.outputs.day_number }}
        BAEKJOON_DAY=$(( $DAY_NUMBER - 79 ))
        PROBLEM_NUMBER="${{ steps.find_folder.outputs.problem_number }}"
        PROBLEM_NAME="${{ steps.find_folder.outputs.problem_name }}"
        SUBMITTED_COUNT=${{ steps.check.outputs.submitted_count }}
        MISSING_COUNT=${{ steps.check.outputs.missing_count }}
        TOTAL_MEMBERS=${{ steps.check.outputs.total_members }}
        SUBMITTED_LIST="${{ steps.check.outputs.submitted_list }}"
        MISSING_LIST="${{ steps.check.outputs.missing_list }}"
        
        if [ $MISSING_COUNT -eq 0 ]; then
          COLOR=65280
          TITLE="üéâ Day $DAY_NUMBER Ï†úÏ∂ú ÏôÑÎ£å!"
        elif [ $MISSING_COUNT -eq $TOTAL_MEMBERS ]; then
          COLOR=16711680
          TITLE="üò± Day $DAY_NUMBER ÏïÑÎ¨¥ÎèÑ Ï†úÏ∂ú ÏïàÌï®!"
        else
          COLOR=16776960
          TITLE="‚ö†Ô∏è Day $DAY_NUMBER Ï†úÏ∂ú ÌòÑÌô©"
        fi
        
        DISCORD_MESSAGE=$(cat << EOF
        {
          "embeds": [{
            "title": "$TITLE",
            "description": "**Day $DAY_NUMBER** (Î∞±Ï§Ä Day $BAEKJOON_DAY) - [$PROBLEM_NUMBER] $PROBLEM_NAME Ï†úÏ∂ú ÌòÑÌô© (23:30 Í∏∞Ï§Ä)",
            "color": $COLOR,
            "fields": [
              {
                "name": "üìä Ï†úÏ∂ú ÌòÑÌô©",
                "value": "$SUBMITTED_COUNT/$TOTAL_MEMBERS Î™Ö Ï†úÏ∂ú",
                "inline": true
              },
              {
                "name": "üìÖ ÎÇ†Ïßú",
                "value": "${{ steps.calculate.outputs.current_date }}",
                "inline": true
              },
              {
                "name": "‚è∞ Ï≤¥ÌÅ¨ ÏãúÍ∞Ñ",
                "value": "23:30",
                "inline": true
              }
        EOF
        )
        
        if [ ! -z "$SUBMITTED_LIST" ]; then
          DISCORD_MESSAGE+=",{\"name\": \"‚úÖ Ï†úÏ∂ú ÏôÑÎ£å\",\"value\": \"$SUBMITTED_LIST\",\"inline\": false}"
        fi
        
        if [ ! -z "$MISSING_LIST" ]; then
          DISCORD_MESSAGE+=",{\"name\": \"‚ùå ÎØ∏Ï†úÏ∂ú (Î©îÍ∞ÄÏª§Ìîº Ïø†Ìè∞ÏèòÍ∏∞!)\",\"value\": \"$MISSING_LIST\",\"inline\": false}"
        fi
        
        DISCORD_MESSAGE+=$(cat << EOF
            ],
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          }]
        }
        EOF
        )
        
        curl -X POST "$DISCORD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "$DISCORD_MESSAGE"
          
    - name: Log final result
      if: steps.calculate.outputs.out_of_range == 'false'
      run: |
        if [ "${{ steps.find_folder.outputs.folder_found }}" == "true" ]; then
          echo "üìä ÏµúÏ¢Ö Í≤∞Í≥º:"
          echo "Ï†úÏ∂ú: ${{ steps.check.outputs.submitted_count }}/${{ steps.check.outputs.total_members }}"
          echo "ÏôÑÎ£åÏûê: ${{ steps.check.outputs.submitted_list }}"
          echo "ÎØ∏Ï†úÏ∂ú: ${{ steps.check.outputs.missing_list }}"
        else
          echo "üìÇ Ïò§ÎäòÏùò Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
        fi
