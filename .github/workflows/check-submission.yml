# .github/workflows/check-submissions.yml
name: Check Daily Submissions

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 11ì‹œ 30ë¶„ (UTC ê¸°ì¤€ 14:30 = í•œêµ­ì‹œê°„ 23:30)
    - cron: '30 14 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  check-submissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Calculate today's problem
      id: calculate
      run: |
        # ì‹œì‘ ë‚ ì§œ (daily-problem.ymlê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •)
        START_DATE="2025-09-23"
        TODAY=$(date +%Y-%m-%d)
        
        DAYS_DIFF=$(( ( $(date -d "$TODAY" +%s) - $(date -d "$START_DATE" +%s) ) / 86400 ))
        DAY_NUMBER=$(( $DAYS_DIFF + 1 ))
        
        echo "day_number=$DAY_NUMBER" >> $GITHUB_OUTPUT
        echo "current_date=$TODAY" >> $GITHUB_OUTPUT
        
        # ìŠ¤í„°ë”” ê¸°ê°„ ë‚´ì¸ì§€ í™•ì¸
        if [ $DAY_NUMBER -gt 79 ] || [ $DAY_NUMBER -lt 1 ]; then
          echo "out_of_range=true" >> $GITHUB_OUTPUT
        else
          echo "out_of_range=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Get today's problem info
      if: steps.calculate.outputs.out_of_range == 'false'
      id: problem
      run: |
        DAY_NUMBER=${{ steps.calculate.outputs.day_number }}
        PROBLEM_INDEX=$(( $DAY_NUMBER - 1 ))
        
        # ë¬¸ì œ ì´ë¦„ ë°°ì—´ (daily-problem.ymlê³¼ ë™ì¼)
        declare -a problem_names=(
          "êµì ì—ë³„ë§Œë“¤ê¸°"
          "ì‚¼ê°ë‹¬íŒ½ì´"
          "ê±°ë¦¬ë‘ê¸°í™•ì¸í•˜ê¸°"
          "í–‰ë ¬ì˜ê³±ì…ˆ"
          "ìì—°ìˆ˜ë’¤ì§‘ì–´ë°°ì—´ë¡œë§Œë“¤ê¸°"
          "ì‹œì €ì•”í˜¸"
          "ì´ìƒí•œë¬¸ìë§Œë“¤ê¸°"
          "ë¬¸ìì—´ì••ì¶•"
          "3ì§„ë²•ë’¤ì§‘ê¸°"
          "ì´ì§„ë³€í™˜ë°˜ë³µí•˜ê¸°"
          "ë¬¸ìì—´ë‚´pì™€yì˜ê°œìˆ˜"
          "ìˆ«ìë¬¸ìì—´ê³¼ì˜ë‹¨ì–´"
          "ë¬¸ìì—´ë‹¤ë£¨ê¸°ê¸°ë³¸"
          "ì‹ ê·œì•„ì´ë””ì¶”ì²œ"
          "ì¿¼ë“œì••ì¶•í›„ê°œìˆ˜ì„¸ê¸°"
          "í•˜ë…¸ì´ì˜íƒ‘"
          "ëª¨ìŒì‚¬ì „"
          "ëª¨ì˜ê³ ì‚¬"
          "ì¹´í«"
          "ìˆ˜ì‹ìµœëŒ€í™”"
          "ì†Œìˆ˜ì°¾ê¸°"
          "ë¶ˆëŸ‰ì‚¬ìš©ì"
          "Kë²ˆì§¸ìˆ˜"
          "ë‘ê°œë½‘ì•„ì„œë”í•˜ê¸°"
          "H-index"
          "ë¬¸ìì—´ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œë°°ì¹˜í•˜ê¸°"
          "ë¬¸ìì—´ë‚´ë§ˆìŒëŒ€ë¡œì •ë ¬í•˜ê¸°"
          "ê°€ì¥í°ìˆ˜"
          "ë©”ë‰´ë¦¬ë‰´ì–¼"
          "ìˆœìœ„ê²€ìƒ‰"
          "ì…êµ­ì‹¬ì‚¬"
          "ì§•ê²€ë‹¤ë¦¬"
          "ì „í™”ë²ˆí˜¸ëª©ë¡"
          "ì¤‘ë³µëœë¬¸ìì œê±°"
          "Aë¡œBë§Œë“¤ê¸°"
          "ì—†ëŠ”ìˆ«ìë”í•˜ê¸°"
          "ì™„ì£¼í•˜ì§€ëª»í•œì„ ìˆ˜"
          "í”¼ë³´ë‚˜ì¹˜ìˆ˜"
          "ì •ìˆ˜ì‚¼ê°í˜•"
          "ë“±êµ£ê¸¸"
          "ì‚¬ì¹™ì—°ì‚°"
          "ì˜¬ë°”ë¥¸ê´„í˜¸"
          "ê´„í˜¸íšŒì „í•˜ê¸°"
          "ì£¼ì‹ê°€ê²©"
          "ê¸°ëŠ¥ê°œë°œ"
          "ë‹¤ë¦¬ë¥¼ì§€ë‚˜ëŠ”íŠ¸ëŸ­"
          "ìˆœìœ„"
          "ë°©ì˜ê°œìˆ˜"
          "ê¸¸ì°¾ê¸°ê²Œì„"
          "ì´ì¤‘ìš°ì„ ìˆœìœ„í"
          "ë””ìŠ¤í¬ì»¨íŠ¸ë¡¤ëŸ¬"
          "ë³´ì„ì‡¼í•‘"
          "ì„¬ì—°ê²°í•˜ê¸°"
          "í˜¸í…”ë°©ë°°ì •"
          "ê°€ì‚¬ê²€ìƒ‰"
          "ìŠ¤í‚¬íŠ¸ë¦¬"
          "í‚¤íŒ¨ë“œëˆ„ë¥´ê¸°"
          "íƒ€ê²Ÿë„˜ë²„"
          "ë„¤íŠ¸ì›Œí¬"
          "ë‹¨ì–´ë³€í™˜"
          "ê²Œì„ë§µìµœë‹¨ê±°ë¦¬"
          "ì²´ìœ¡ë³µ"
          "í°ìˆ˜ë§Œë“¤ê¸°"
          "ë‹¨ì†ì¹´ë©”ë¼"
          "ì‹ ê³ ê²°ê³¼ë°›ê¸°"
          "kì§„ìˆ˜ì—ì„œì†Œìˆ˜ê°œìˆ˜êµ¬í•˜ê¸°"
          "ì£¼ì°¨ìš”ê¸ˆê³„ì‚°"
          "ì–‘ê¶ëŒ€íšŒ"
          "ì–‘ê³¼ëŠ‘ëŒ€"
          "íŒŒê´´ë˜ì§€ì•Šì€ê±´ë¬¼"
          "ì‚¬ë¼ì§€ëŠ”ë°œíŒ"
          "ì™¸í†¨ì´ì•ŒíŒŒë²³"
          "ì²´ìœ¡ëŒ€íšŒ"
          "ìœ ì „ë²•ì¹™"
          "ìš´ì˜ì²´ì œ"
          "ì‹¤ìŠµìš©ë¡œë´‡"
          "ì‹ ì…ì‚¬ì›êµìœ¡"
          "ì¹´í˜í™•ì¥"
          "ë³´ë¬¼ì§€ë„"
        )
        
        PROBLEM_NAME="${problem_names[$PROBLEM_INDEX]}"
        FOLDER_PATH="problems/day$(printf "%02d" $DAY_NUMBER)-${PROBLEM_NAME}"
        
        echo "problem_name=$PROBLEM_NAME" >> $GITHUB_OUTPUT
        echo "folder_path=$FOLDER_PATH" >> $GITHUB_OUTPUT
        
    - name: Check submissions
      if: steps.calculate.outputs.out_of_range == 'false'
      id: check
      run: |
        FOLDER_PATH="${{ steps.problem.outputs.folder_path }}"
        
        # ìŠ¤í„°ë””ì› ëª©ë¡
        declare -a members=("í™©ì¸ì°¬" "ìœ ë„í˜„" "ë°°ì€ê²½" "ë‚¨ì—°ìš°")
        
        SUBMITTED=()
        MISSING=()
        
        echo "ğŸ“‚ ì˜¤ëŠ˜ì˜ í´ë”: $FOLDER_PATH"
        
        # í´ë”ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if [ ! -d "$FOLDER_PATH" ]; then
          echo "âŒ ì˜¤ëŠ˜ì˜ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤: $FOLDER_PATH"
          echo "all_missing=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ê° ìŠ¤í„°ë””ì›ì˜ ì œì¶œ íŒŒì¼ í™•ì¸
        for member in "${members[@]}"; do
          # ê°€ëŠ¥í•œ í™•ì¥ìë“¤ ì²´í¬ (.java, .py, .cpp, .js ë“±)
          found=false
          for ext in "java" "py" "cpp" "js" "kt" "go" "swift"; do
            if [ -f "$FOLDER_PATH/${member}.${ext}" ]; then
              SUBMITTED+=("$member")
              found=true
              break
            fi
          done
          
          if [ "$found" = false ]; then
            MISSING+=("$member")
          fi
        done
        
        # ê²°ê³¼ ì •ë¦¬
        SUBMITTED_COUNT=${#SUBMITTED[@]}
        MISSING_COUNT=${#MISSING[@]}
        TOTAL_MEMBERS=${#members[@]}
        
        echo "submitted_count=$SUBMITTED_COUNT" >> $GITHUB_OUTPUT
        echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
        echo "total_members=$TOTAL_MEMBERS" >> $GITHUB_OUTPUT
        echo "all_missing=false" >> $GITHUB_OUTPUT
        
        # ê²°ê³¼ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
        IFS=',' 
        SUBMITTED_LIST="${SUBMITTED[*]}"
        MISSING_LIST="${MISSING[*]}"
        IFS=' '
        
        echo "submitted_list=$SUBMITTED_LIST" >> $GITHUB_OUTPUT
        echo "missing_list=$MISSING_LIST" >> $GITHUB_OUTPUT
        
        # ë¡œê·¸ ì¶œë ¥
        echo "âœ… ì œì¶œ ì™„ë£Œ ($SUBMITTED_COUNT/$TOTAL_MEMBERS): $SUBMITTED_LIST"
        echo "âŒ ë¯¸ì œì¶œ ($MISSING_COUNT/$TOTAL_MEMBERS): $MISSING_LIST"
        
    - name: Send submission status to Discord
      if: steps.calculate.outputs.out_of_range == 'false'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        DAY_NUMBER=${{ steps.calculate.outputs.day_number }}
        PROBLEM_NAME="${{ steps.problem.outputs.problem_name }}"
        SUBMITTED_COUNT=${{ steps.check.outputs.submitted_count }}
        MISSING_COUNT=${{ steps.check.outputs.missing_count }}
        TOTAL_MEMBERS=${{ steps.check.outputs.total_members }}
        SUBMITTED_LIST="${{ steps.check.outputs.submitted_list }}"
        MISSING_LIST="${{ steps.check.outputs.missing_list }}"
        
        # ìƒ‰ìƒ ê²°ì • (ëª¨ë‘ ì œì¶œ: ì´ˆë¡, ì¼ë¶€ ë¯¸ì œì¶œ: ë…¸ë‘, ëª¨ë‘ ë¯¸ì œì¶œ: ë¹¨ê°•)
        if [ $MISSING_COUNT -eq 0 ]; then
          COLOR=65280  # ì´ˆë¡
          TITLE="ğŸ‰ Day $DAY_NUMBER ì œì¶œ ì™„ë£Œ!"
        elif [ $MISSING_COUNT -eq $TOTAL_MEMBERS ]; then
          COLOR=16711680  # ë¹¨ê°•
          TITLE="ğŸ˜± Day $DAY_NUMBER ì•„ë¬´ë„ ì œì¶œ ì•ˆí•¨!"
        else
          COLOR=16776960  # ë…¸ë‘
          TITLE="âš ï¸ Day $DAY_NUMBER ì œì¶œ í˜„í™©"
        fi
        
        # Discord ë©”ì‹œì§€ ìƒì„±
        DISCORD_MESSAGE=$(cat << EOF
        {
          "embeds": [{
            "title": "$TITLE",
            "description": "**Day $DAY_NUMBER** - $PROBLEM_NAME ì œì¶œ í˜„í™© (23:30 ê¸°ì¤€)",
            "color": $COLOR,
            "fields": [
              {
                "name": "ğŸ“Š ì œì¶œ í˜„í™©",
                "value": "$SUBMITTED_COUNT/$TOTAL_MEMBERS ëª… ì œì¶œ",
                "inline": true
              },
              {
                "name": "ğŸ“… ë‚ ì§œ",
                "value": "${{ steps.calculate.outputs.current_date }}",
                "inline": true
              },
              {
                "name": "â° ì²´í¬ ì‹œê°„",
                "value": "23:30",
                "inline": true
              }
        EOF
        )
        
        # ì œì¶œ ì™„ë£Œì ëª©ë¡ ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
        if [ ! -z "$SUBMITTED_LIST" ]; then
          DISCORD_MESSAGE+=",{\"name\": \"âœ… ì œì¶œ ì™„ë£Œ\",\"value\": \"$SUBMITTED_LIST\",\"inline\": false}"
        fi
        
        # ë¯¸ì œì¶œì ëª©ë¡ ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
        if [ ! -z "$MISSING_LIST" ]; then
          DISCORD_MESSAGE+=",{\"name\": \"âŒ ë¯¸ì œì¶œ (ë©”ê°€ì»¤í”¼ íƒ€ì„!)\",\"value\": \"$MISSING_LIST\",\"inline\": false}"
        fi
        
        # ë©”ì‹œì§€ ë§ˆë¬´ë¦¬
        DISCORD_MESSAGE+=$(cat << EOF
            ],
            "footer": {
              "text": "ì œì¶œì€ ë‚´ì¼ ì˜¤ì „ 9ì‹œ ì „ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤"
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          }]
        }
        EOF
        )
        
        # Discordë¡œ ì „ì†¡
        curl -X POST "$DISCORD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "$DISCORD_MESSAGE"
          
    - name: Log final result
      if: steps.calculate.outputs.out_of_range == 'false'
      run: |
        echo "ğŸ“Š ìµœì¢… ê²°ê³¼:"
        echo "ì œì¶œ: ${{ steps.check.outputs.submitted_count }}/${{ steps.check.outputs.total_members }}"
        echo "ì™„ë£Œì: ${{ steps.check.outputs.submitted_list }}"
        echo "ë¯¸ì œì¶œ: ${{ steps.check.outputs.missing_list }}"
