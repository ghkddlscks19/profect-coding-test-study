# .github/workflows/daily-problem-baekjoon-random.yml
name: Daily Random Baekjoon Problem

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC ê¸°ì¤€ 0ì‹œ = í•œêµ­ì‹œê°„ 9ì‹œ)
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  send-daily-problem:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Calculate day number
      id: calculate
      run: |
        START_DATE="2025-12-10"
        TODAY=$(date +%Y-%m-%d)
        
        DAYS_DIFF=$(( ( $(date -d "$TODAY" +%s) - $(date -d "$START_DATE" +%s) ) / 86400 ))
        # í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ê°€ Day 1-79ì˜€ìœ¼ë¯€ë¡œ ë°±ì¤€ì€ Day 80ë¶€í„° ì‹œì‘
        DAY_NUMBER=$(( $DAYS_DIFF + 80 ))
        
        echo "day_number=$DAY_NUMBER" >> $GITHUB_OUTPUT
        echo "current_date=$TODAY" >> $GITHUB_OUTPUT
        
        if [ $DAY_NUMBER -lt 80 ]; then
          echo "not_started=true" >> $GITHUB_OUTPUT
        else
          echo "not_started=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Get random problem from solved.ac
      if: steps.calculate.outputs.not_started == 'false'
      id: problem
      run: |
        python << 'PYTHON_SCRIPT'
        import requests
        import random
        import os
        import time
        import glob
        import re
        
        def get_tier_name(tier_level):
            tiers = {
                8: "Silver III", 9: "Silver II", 10: "Silver I",
                11: "Gold V", 12: "Gold IV", 13: "Gold III", 14: "Gold II"
            }
            return tiers.get(tier_level, "Unknown")
        
        def get_solved_problems():
            """ì´ë¯¸ í’€ì—ˆë˜ ë¬¸ì œ ë²ˆí˜¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
            solved = set()
            
            # problems/ í´ë”ì—ì„œ ëª¨ë“  í´ë” ì°¾ê¸°
            if os.path.exists('problems'):
                folders = glob.glob('problems/day*')
                for folder in folders:
                    # í´ë”ëª…ì—ì„œ ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ
                    # í˜•ì‹: day0080-1753-ìµœë‹¨ê²½ë¡œ
                    match = re.search(r'day\d+-(\d+)-', folder)
                    if match:
                        problem_num = match.group(1)
                        solved.add(problem_num)
            
            print(f"ğŸ“š ì´ë¯¸ í’€ì€ ë¬¸ì œ ìˆ˜: {len(solved)}ê°œ")
            if solved and len(solved) <= 10:
                print(f"   ë¬¸ì œ ë²ˆí˜¸: {sorted(solved)}")
            
            return solved
        
        def get_random_problem():
            # ì´ë¯¸ í’€ì€ ë¬¸ì œ ëª©ë¡
            solved_problems = get_solved_problems()
            
            max_attempts = 50  # ìµœëŒ€ 50ë²ˆ ì‹œë„
            
            for attempt in range(max_attempts):
                # Silver 3 ~ Gold 2 ë²”ìœ„ì—ì„œ ëœë¤ ë‚œì´ë„ ì„ íƒ
                tier = random.randint(8, 14)
                
                # solved.ac API í˜¸ì¶œ (ëœë¤ í˜ì´ì§€)
                random_page = random.randint(1, 20)
                
                url = "https://solved.ac/api/v3/search/problem"
                params = {
                    "query": f"tier:{tier} solved:1000..",  # 1000ëª… ì´ìƒ í‘¼ ë¬¸ì œ
                    "page": random_page,
                    "sort": "random",  # ëœë¤ ì •ë ¬
                    "direction": "desc"
                }
                
                try:
                    response = requests.get(url, params=params, timeout=10)
                    
                    if response.status_code == 200:
                        data = response.json()
                        items = data.get("items", [])
                        
                        if items:
                            # í˜ì´ì§€ ë‚´ì—ì„œ ëœë¤ ì„ íƒ
                            random.shuffle(items)  # ìˆœì„œ ì„ê¸°
                            
                            for problem in items:
                                problem_id = str(problem.get("problemId"))
                                
                                # ì¤‘ë³µ ì²´í¬
                                if problem_id not in solved_problems:
                                    title = problem.get("titleKo")
                                    level = problem.get("level")
                                    tags = problem.get("tags", [])
                                    
                                    # ì•Œê³ ë¦¬ì¦˜ ë¶„ë¥˜ ì¶”ì¶œ
                                    tag_names = []
                                    for tag in tags[:2]:
                                        tag_name = tag.get("displayNames", [{}])[0].get("name", "")
                                        if tag_name:
                                            tag_names.append(tag_name)
                                    
                                    category = ", ".join(tag_names) if tag_names else "êµ¬í˜„"
                                    tier_name = get_tier_name(level)
                                    
                                    # GitHub Actions output ì„¤ì •
                                    with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                                        f.write(f"number={problem_id}\n")
                                        f.write(f"name={title}\n")
                                        f.write(f"tier={tier_name}\n")
                                        f.write(f"category={category}\n")
                                        # í´ë”ëª…ìš© clean name
                                        clean_name = ''.join(c for c in title if c.isalnum() or c in ' ')
                                        clean_name = clean_name.replace(' ', '')
                                        f.write(f"clean_name={clean_name}\n")
                                    
                                    print(f"âœ… ìƒˆë¡œìš´ ë¬¸ì œ ì„ íƒ ì™„ë£Œ: [{problem_id}] {title}")
                                    print(f"   ë‚œì´ë„: {tier_name}, ë¶„ë¥˜: {category}")
                                    print(f"   ì‹œë„ íšŸìˆ˜: {attempt + 1}/{max_attempts}")
                                    return True
                            
                            # í•´ë‹¹ í˜ì´ì§€ì˜ ëª¨ë“  ë¬¸ì œê°€ ì¤‘ë³µ
                            print(f"âš ï¸  í˜ì´ì§€ {random_page}ì˜ ëª¨ë“  ë¬¸ì œê°€ ì¤‘ë³µ (ì‹œë„ {attempt + 1}/{max_attempts})")
                    
                except Exception as e:
                    print(f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}): {e}")
                
                time.sleep(0.3)  # API ì œí•œ ë°©ì§€
            
            print(f"âŒ {max_attempts}ë²ˆ ì‹œë„í–ˆì§€ë§Œ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return False
        
        # ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„
        for main_attempt in range(5):
            if get_random_problem():
                break
            print(f"ì¬ì‹œë„ {main_attempt + 1}/5...")
            time.sleep(1)
        else:
            # ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë¬¸ì œ ì‚¬ìš©
            print("âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨, ê¸°ë³¸ ë¬¸ì œ ì‚¬ìš©")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("number=1000\n")
                f.write("name=A+B\n")
                f.write("tier=Bronze V\n")
                f.write("category=ìˆ˜í•™\n")
                f.write("clean_name=AB\n")
        
        PYTHON_SCRIPT
        
    - name: Create problem folder
      if: steps.calculate.outputs.not_started == 'false'
      id: folder
      run: |
        DAY_NUM=${{ steps.calculate.outputs.day_number }}
        PROBLEM_NUM="${{ steps.problem.outputs.number }}"
        PROBLEM_NAME="${{ steps.problem.outputs.clean_name }}"
        
        FOLDER_NAME="day$(printf "%04d" $DAY_NUM)-${PROBLEM_NUM}-${PROBLEM_NAME}"
        FOLDER_PATH="problems/${FOLDER_NAME}"
        
        if [ -d "$FOLDER_PATH" ]; then
          echo "ğŸ“ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: $FOLDER_PATH"
          echo "folder_created=false" >> $GITHUB_OUTPUT
        else
          mkdir -p "$FOLDER_PATH"
          
          # .gitkeep íŒŒì¼ ìƒì„± (ë¹ˆ í´ë”ë„ ì»¤ë°‹ë˜ë„ë¡)
          touch "$FOLDER_PATH/.gitkeep"
          
          echo "ğŸ“ ìƒˆ í´ë” ìƒì„±: $FOLDER_PATH"
          echo "folder_created=true" >> $GITHUB_OUTPUT
          echo "folder_path=$FOLDER_PATH" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push folder
      if: steps.calculate.outputs.not_started == 'false'
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ğŸ—‚ï¸ Day ${{ steps.calculate.outputs.day_number }}: [${{ steps.problem.outputs.number }}] ${{ steps.problem.outputs.name }}"
          git push origin main
          echo "âœ… ìƒˆ í´ë”ë¥¼ ì»¤ë°‹í•˜ê³  í‘¸ì‹œí–ˆìŠµë‹ˆë‹¤!"
        else
          echo "ğŸ“‚ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: Send daily problem to Discord
      if: steps.calculate.outputs.not_started == 'false'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        DISCORD_MESSAGE=$(cat << EOF
        {
          "embeds": [{
            "title": "ğŸ² ì˜¤ëŠ˜ì˜ ëœë¤ ë°±ì¤€ ë¬¸ì œ [${{ steps.problem.outputs.tier }}]",
            "description": "**Day ${{ steps.calculate.outputs.day_number }}** (ë°±ì¤€ Day $(( ${{ steps.calculate.outputs.day_number }} - 79 ))) - [${{ steps.problem.outputs.number }}] ${{ steps.problem.outputs.name }}",
            "color": 15844367,
            "fields": [
              {
                "name": "ğŸ† ë‚œì´ë„",
                "value": "${{ steps.problem.outputs.tier }}",
                "inline": true
              },
              {
                "name": "ğŸ“… ë‚ ì§œ",
                "value": "${{ steps.calculate.outputs.current_date }}",
                "inline": true
              },
              {
                "name": "ğŸ”— ë¬¸ì œ ë§í¬",
                "value": "[ë°±ì¤€ ${{ steps.problem.outputs.number }}ë²ˆ](https://www.acmicpc.net/problem/${{ steps.problem.outputs.number }})",
                "inline": false
              },
              {
                "name": "ğŸ“‚ í´ë” ê²½ë¡œ",
                "value": "\`problems/day$(printf "%04d" ${{ steps.calculate.outputs.day_number }})-${{ steps.problem.outputs.number }}-${{ steps.problem.outputs.clean_name }}/\`",
                "inline": false
              }
            ],
            "footer": {
              "text": "ğŸ’ª ë§¤ì¼ ìƒˆë¡œìš´ ë¬¸ì œë¡œ ì‹¤ë ¥ UP! ğŸš€"
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          }]
        }
        EOF
        )
        
        curl -X POST "$DISCORD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "$DISCORD_MESSAGE"
          
    - name: Send not started message
      if: steps.calculate.outputs.not_started == 'true'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        NOT_STARTED_MESSAGE=$(cat << EOF
        {
          "embeds": [{
            "title": "â° ì•„ì§ ì‹œì‘ ì „ì…ë‹ˆë‹¤",
            "description": "ë°±ì¤€ ëœë¤ ë¬¸ì œëŠ” í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ 79ì¼ì„ ì™„ë£Œí•œ í›„ ì‹œì‘ë©ë‹ˆë‹¤.",
            "color": 16776960,
            "fields": [
              {
                "name": "ğŸ“… ì‹œì‘ ì˜ˆì •ì¼",
                "value": "2025-12-11 (Day 80ë¶€í„°)",
                "inline": true
              },
              {
                "name": "ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ",
                "value": "${{ steps.calculate.outputs.current_date }}",
                "inline": true
              },
              {
                "name": "ğŸ“š í˜„ì¬ ì§„í–‰",
                "value": "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ Day ${{ steps.calculate.outputs.day_number }}/79",
                "inline": true
              }
            ],
            "footer": {
              "text": "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ ì™„ë£Œ í›„ ë°±ì¤€ ì‹œì‘! â³"
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          }]
        }
        EOF
        )
        
        curl -X POST "$DISCORD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "$NOT_STARTED_MESSAGE"
          
    - name: Log success
      run: |
        if [ "${{ steps.calculate.outputs.not_started }}" == "true" ]; then
          echo "â° ì•„ì§ ì‹œì‘ ì „ì…ë‹ˆë‹¤."
        else
          echo "âœ… ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“… ë‚ ì§œ: ${{ steps.calculate.outputs.current_date }}"
          echo "ğŸ“š ë¬¸ì œ: [${{ steps.problem.outputs.number }}] ${{ steps.problem.outputs.name }}"
          echo "ğŸ”¢ Day: ${{ steps.calculate.outputs.day_number }}"
          echo "ğŸ² ë‚œì´ë„: ${{ steps.problem.outputs.tier }}"
          echo "ğŸ“‚ ì•Œê³ ë¦¬ì¦˜: ${{ steps.problem.outputs.category }}"
        fi
